// Code generated by qtc from "stores.qtpl". DO NOT EDIT.
// See https://github.com/valyala/quicktemplate for details.

//line stores.qtpl:1
package templates

//line stores.qtpl:1
import "strings"

//line stores.qtpl:2
import (
	qtio422016 "io"

	qt422016 "github.com/valyala/quicktemplate"
)

//line stores.qtpl:2
var (
	_ = qtio422016.Copy
	_ = qt422016.AcquireByteBuffer
)

//line stores.qtpl:2
func StreamStores(qw422016 *qt422016.Writer, input *StoresInput) {
//line stores.qtpl:2
	qw422016.N().S(`
// Code generated by ormgen; DO NOT EDIT.

package `)
//line stores.qtpl:5
	qw422016.E().S(input.Package.Name)
//line stores.qtpl:5
	qw422016.N().S(`

import (
	"context"
	"github.com/pkg/errors"
	
	"github.com/jamillosantos/orm"

`)
//line stores.qtpl:13
	if !input.ModelsPackage.Equals(input.Package) {
//line stores.qtpl:13
		qw422016.N().S(`
	"`)
//line stores.qtpl:14
		qw422016.E().S(input.ModelsPackage.ImportPath)
//line stores.qtpl:14
		qw422016.N().S(`"
`)
//line stores.qtpl:15
	}
//line stores.qtpl:15
	qw422016.N().S(`
)

`)
//line stores.qtpl:18
	for _, record := range input.Records {
//line stores.qtpl:18
		qw422016.N().S(`type `)
//line stores.qtpl:19
		qw422016.E().S(record.Store.Type)
//line stores.qtpl:19
		qw422016.N().S(` struct {
	conn orm.Connection
}

func New`)
//line stores.qtpl:23
		qw422016.E().S(record.Store.Type)
//line stores.qtpl:23
		qw422016.N().S(`(conn orm.Connection) *`)
//line stores.qtpl:23
		qw422016.E().S(record.Store.Type)
//line stores.qtpl:23
		qw422016.N().S(` {
	return &`)
//line stores.qtpl:24
		qw422016.E().S(record.Store.Type)
//line stores.qtpl:24
		qw422016.N().S(`{
		conn,
	}
}

func (store *`)
//line stores.qtpl:29
		qw422016.E().S(record.Store.Type)
//line stores.qtpl:29
		qw422016.N().S(`) Insert(record *`)
//line stores.qtpl:29
		qw422016.E().S(input.ModelsPackage.Ref(input.Package, record.Name))
//line stores.qtpl:29
		qw422016.N().S(`, fields ...orm.SchemaField) error {
	return store.InsertContext(context.Background(), record, fields...)
}

func (store *`)
//line stores.qtpl:33
		qw422016.E().S(record.Store.Type)
//line stores.qtpl:33
		qw422016.N().S(`) InsertContext(ctx context.Context, record *`)
//line stores.qtpl:33
		qw422016.E().S(input.ModelsPackage.Ref(input.Package, record.Name))
//line stores.qtpl:33
		qw422016.N().S(`, fields ...orm.SchemaField) error {
	if len(fields) == 0 {
		fields = `)
//line stores.qtpl:35
		qw422016.E().S(record.Schema.InternalRef)
//line stores.qtpl:35
		qw422016.N().S(`Fields
	}

	var recordItf interface{} = record

	if biH, ok := recordItf.(orm.HookBeforeInsert); ok {
		err := biH.BeforeInsert(ctx, fields...)
		if err != nil {
			return err
		}
	}

	if bsH, ok := recordItf.(orm.HookBeforeSave); ok {
		err := bsH.BeforeSave(ctx, fields...)
		if err != nil {
			return err
		}
	}

	aiH, aiHOk := recordItf.(orm.HookAfterInsert)
	asH, asHOk := recordItf.(orm.HookAfterSave)

	columnNames := make([]interface{}, len(fields))
	columnValues := make([]interface{}, len(fields))
	var err error
	for i, field := range fields {
		var fieldAddr interface{}
		`)
//line stores.qtpl:62
		StreamColumnAddresses(qw422016, &ColumnAddressesInput{
			FieldName:  "field.Name()",
			TargetName: "fieldAddr",
			RecordName: "record",
			ErrName:    "err",
			Record:     record,
		})
//line stores.qtpl:68
		qw422016.N().S(`
		if err != nil {
			if aiHOk {
				aiH.AfterInsert(ctx, err, fields...)
			}
			if asHOk {
				asH.AfterSave(ctx, err, fields...)
			}
			return err
		}
		columnNames[i] = field.String()
		columnValues[i] = fieldAddr
	}
	builder := store.conn.Builder().Insert(`)
//line stores.qtpl:81
		qw422016.E().S(record.Schema.InternalRef)
//line stores.qtpl:81
		qw422016.N().S(`.Table(), columnNames...).Values(columnValues...)`)
//line stores.qtpl:81
		if record.FieldAutoInc != nil {
//line stores.qtpl:81
			qw422016.N().S(`.Returning("`)
//line stores.qtpl:81
			qw422016.E().S(record.FieldAutoInc.Name)
//line stores.qtpl:81
			qw422016.N().S(`")`)
//line stores.qtpl:81
		}
//line stores.qtpl:81
		qw422016.N().S(`

	sql, args, err := builder.ToSQL()
	if err != nil {
		if aiHOk {
			aiH.AfterInsert(ctx, err, fields...)
		}
		if asHOk {
			asH.AfterSave(ctx, err, fields...)
		}
		return err
	}
`)
//line stores.qtpl:93
		if record.FieldAutoInc == nil {
//line stores.qtpl:93
			qw422016.N().S(`
	_, err = store.conn.Exec(ctx, sql, args...)

	if aiHOk {
		aiH.AfterInsert(ctx, err, fields...)
	}
	if asHOk {
		asH.AfterSave(ctx, err, fields...)
	}

	return err
`)
//line stores.qtpl:104
		} else {
//line stores.qtpl:104
			qw422016.N().S(`
	var id `)
//line stores.qtpl:105
			qw422016.E().S(record.FieldAutoInc.Type)
//line stores.qtpl:105
			qw422016.N().S(`
	err = store.conn.QueryRow(ctx, sql, args...).Scan(&id)
	if err != nil {
		if aiHOk {
			aiH.AfterInsert(ctx, err, fields...)
		}
		if asHOk {
			asH.AfterSave(ctx, err, fields...)
		}
		return err
	}
	record.`)
//line stores.qtpl:116
			qw422016.E().S(record.FieldAutoInc.GoName)
//line stores.qtpl:116
			qw422016.N().S(` = id
	if aiHOk {
		aiH.AfterInsert(ctx, nil, fields...)
	}
	if asHOk {
		asH.AfterSave(ctx, err, fields...)
	}
	return nil
`)
//line stores.qtpl:124
		}
//line stores.qtpl:124
		qw422016.N().S(`
}

func (store *`)
//line stores.qtpl:127
		qw422016.E().S(record.Store.Type)
//line stores.qtpl:127
		qw422016.N().S(`) Update(record *`)
//line stores.qtpl:127
		qw422016.E().S(input.ModelsPackage.Ref(input.Package, record.Name))
//line stores.qtpl:127
		qw422016.N().S(`, fields ...orm.SchemaField) (int64, error) {
	return store.UpdateContext(context.Background(), record, fields...)
}

func (store *`)
//line stores.qtpl:131
		qw422016.E().S(record.Store.Type)
//line stores.qtpl:131
		qw422016.N().S(`) UpdateContext(ctx context.Context, record *`)
//line stores.qtpl:131
		qw422016.E().S(input.ModelsPackage.Ref(input.Package, record.Name))
//line stores.qtpl:131
		qw422016.N().S(`, fields ...orm.SchemaField) (int64, error) {
	if len(fields) == 0 {
		fields = `)
//line stores.qtpl:133
		qw422016.E().S(record.Schema.InternalRef)
//line stores.qtpl:133
		qw422016.N().S(`Fields
	}

	var recordItf interface{} = record

	if buH, ok := recordItf.(orm.HookBeforeUpdate); ok {
		err := buH.BeforeUpdate(ctx, fields...)
		if err != nil {
			return 0, err
		}
	}
	
	if bsH, ok := recordItf.(orm.HookBeforeSave); ok {
		err := bsH.BeforeSave(ctx, fields...)
		if err != nil {
			return 0, err
		}
	}

	auH, auHOk := recordItf.(orm.HookAfterUpdate)
	asH, asHOk := recordItf.(orm.HookAfterSave)

	builder := store.conn.Builder().Update(`)
//line stores.qtpl:155
		qw422016.E().S(record.Schema.InternalRef)
//line stores.qtpl:155
		qw422016.N().S(`.Table())
	var err error
	for _, field := range fields {
		var fieldAddr interface{}
		`)
//line stores.qtpl:159
		StreamColumnAddresses(qw422016, &ColumnAddressesInput{
			FieldName:  "field.Name()",
			TargetName: "fieldAddr",
			RecordName: "record",
			ErrName:    "err",
			Record:     record,
		})
//line stores.qtpl:165
		qw422016.N().S(`
		if err != nil {
			if auHOk {
				auH.AfterUpdate(ctx, err, fields...)
			}
			if asHOk {
				asH.AfterSave(ctx, err, fields...)
			}
			return 0, err
		}
		builder = builder.Set(field.String(), fieldAddr)
	}
`)
//line stores.qtpl:177
		for _, field := range record.PrimaryKey {
//line stores.qtpl:177
			qw422016.N().S(`
	builder.Where("`)
//line stores.qtpl:178
			qw422016.E().J(field.Name)
//line stores.qtpl:178
			qw422016.N().S(` = ?", record.`)
//line stores.qtpl:178
			qw422016.E().S(field.GoName)
//line stores.qtpl:178
			qw422016.N().S(`)
`)
//line stores.qtpl:179
		}
//line stores.qtpl:179
		qw422016.N().S(`

	sql, params, err := builder.ToSQL()
	if err != nil {
		return 0, err
	}

	r, err := store.conn.Exec(ctx, sql, params...)
	if err != nil {
		if auHOk {
			auH.AfterUpdate(ctx, err, fields...)
		}
		if asHOk {
			asH.AfterSave(ctx, err, fields...)
		}
		return 0, err
	}
	rowsAffected, err := r.RowsAffected()
	if err != nil {
		return 0, err
	}
	if auHOk {
		auH.AfterUpdate(ctx, nil, fields...)
	}
	if asHOk {
		asH.AfterSave(ctx, nil, fields...)
	}
	return rowsAffected, nil
}

func (store *`)
//line stores.qtpl:209
		qw422016.E().S(record.Store.Type)
//line stores.qtpl:209
		qw422016.N().S(`) Delete(records ...*`)
//line stores.qtpl:209
		qw422016.E().S(input.ModelsPackage.Ref(input.Package, record.Name))
//line stores.qtpl:209
		qw422016.N().S(`) (int64, error) {
	return store.DeleteContext(context.Background(), records...)
}

func (store *`)
//line stores.qtpl:213
		qw422016.E().S(record.Store.Type)
//line stores.qtpl:213
		qw422016.N().S(`) DeleteContext(ctx context.Context, records ...*`)
//line stores.qtpl:213
		qw422016.E().S(input.ModelsPackage.Ref(input.Package, record.Name))
//line stores.qtpl:213
		qw422016.N().S(`) (int64, error) {
	builder := store.conn.Builder().Delete(`)
//line stores.qtpl:214
		qw422016.E().S(record.Schema.InternalRef)
//line stores.qtpl:214
		qw422016.N().S(`.Table())

	if len(records) > 1 {
		ids := make([]interface{}, len(records) * `)
//line stores.qtpl:217
		qw422016.N().D(len(record.PrimaryKey))
//line stores.qtpl:217
		qw422016.N().S(`)

`)
//line stores.qtpl:219
		if len(record.PrimaryKey) == 1 {
//line stores.qtpl:219
			qw422016.N().S(`
		for i, record := range records {
			var recordItf interface{} = record

			if bdH, bdHOk := recordItf.(orm.HookBeforeDelete); bdHOk {
				err := bdH.BeforeDelete(ctx)
				if err != nil {
					return 0, err
				}
			}
			ids[i] = record.`)
//line stores.qtpl:229
			qw422016.E().S(record.PrimaryKey[0].GoName)
//line stores.qtpl:229
			qw422016.N().S(`
		}
		builder = builder.Where("`)
//line stores.qtpl:231
			qw422016.E().J(record.PrimaryKey[0].Name)
//line stores.qtpl:231
			qw422016.N().S(` IN ?", ids)
`)
//line stores.qtpl:232
		} else {
//line stores.qtpl:232
			qw422016.N().S(`
		var (
			pkSB strings.Builder
		)

		pks := make([]interface{}, len(records) * len(record.PrimaryKey))

		for i, record := range records {
			if bdH, bdHOk := recordItf.(orm.HookBeforeDelete); bdHOk {
				err := bdH.BeforeDelete(ctx)
				if err != nil {
					return 0, err
				}
			}

`)
//line stores.qtpl:248
			var recordPkSB strings.Builder
			for i, field := range record.PrimaryKey {
				if i > 0 {
					recordPkSB.WriteString(" AND ")
				}
				recordPkSB.WriteString(field.Name)
				recordPkSB.WriteString(" = ?")
			}

//line stores.qtpl:256
			qw422016.N().S(`			if i > 0 {
				pkSB.WriteString(" OR ")
			}
			pkSB.WriteString("(`)
//line stores.qtpl:260
			qw422016.E().J(recordPkSB.String())
//line stores.qtpl:260
			qw422016.N().S(`)")
			pks = append(pks, 
`)
//line stores.qtpl:262
			for _, field := range record.PrimaryKey {
//line stores.qtpl:262
				qw422016.N().S(`				records[i].`)
//line stores.qtpl:263
				qw422016.E().S(field.GoName)
//line stores.qtpl:263
				qw422016.N().S(`,
`)
//line stores.qtpl:264
			}
//line stores.qtpl:264
			qw422016.N().S(`			)
		}
		builder = builder.Where(pkSB.String(), pks...)
`)
//line stores.qtpl:268
		}
//line stores.qtpl:268
		qw422016.N().S(`
	} else if len(records) == 1 {
		var recordItf interface{} = records[0]
		if bdH, bdHOk := recordItf.(orm.HookBeforeDelete); bdHOk {
			err := bdH.BeforeDelete(ctx)
			if err != nil {
				return 0, err
			}
		}

`)
//line stores.qtpl:278
		if len(record.PrimaryKey) == 1 {
//line stores.qtpl:278
			qw422016.N().S(`		builder = builder.Where("`)
//line stores.qtpl:279
			qw422016.E().J(record.PrimaryKey[0].Name)
//line stores.qtpl:279
			qw422016.N().S(` = ?", records[0].`)
//line stores.qtpl:279
			qw422016.E().S(record.PrimaryKey[0].GoName)
//line stores.qtpl:279
			qw422016.N().S(`)
`)
//line stores.qtpl:280
		} else {
//line stores.qtpl:280
			qw422016.N().S(`
		builder
`)
//line stores.qtpl:282
			for _, field := range record.PrimaryKey {
//line stores.qtpl:282
				qw422016.N().S(`	.Where("`)
//line stores.qtpl:283
				qw422016.E().J(field.Name)
//line stores.qtpl:283
				qw422016.N().S(` IN ", records[0].`)
//line stores.qtpl:283
				qw422016.E().S(field.GoName)
//line stores.qtpl:283
				qw422016.N().S(`)
`)
//line stores.qtpl:284
			}
//line stores.qtpl:285
		}
//line stores.qtpl:285
		qw422016.N().S(`	} else {
		return 0, nil
	}

	sql, sqlParams, err := builder.ToSQL()
	if err != nil {
		return 0, nil
	}

	r, err := store.conn.Exec(ctx, sql, sqlParams...)
	if err != nil {
		for _, record := range records {
			var recordItf interface{} = record
			if adH, adHOk := recordItf.(orm.HookAfterDelete); adHOk {
				adH.AfterDelete(ctx, err)
			}
		}
		return 0, err
	}
	return r.RowsAffected()
}

`)
//line stores.qtpl:308
	}
//line stores.qtpl:309
}

//line stores.qtpl:309
func WriteStores(qq422016 qtio422016.Writer, input *StoresInput) {
//line stores.qtpl:309
	qw422016 := qt422016.AcquireWriter(qq422016)
//line stores.qtpl:309
	StreamStores(qw422016, input)
//line stores.qtpl:309
	qt422016.ReleaseWriter(qw422016)
//line stores.qtpl:309
}

//line stores.qtpl:309
func Stores(input *StoresInput) string {
//line stores.qtpl:309
	qb422016 := qt422016.AcquireByteBuffer()
//line stores.qtpl:309
	WriteStores(qb422016, input)
//line stores.qtpl:309
	qs422016 := string(qb422016.B)
//line stores.qtpl:309
	qt422016.ReleaseByteBuffer(qb422016)
//line stores.qtpl:309
	return qs422016
//line stores.qtpl:309
}
